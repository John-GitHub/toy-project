# File: standars/warehouse_modeling.standard.yaml

standard_id: warehouse_modeling
version: "1.0.1"
description: >
  Conventions for warehouse-facing schemas (dimensions and facts). Raw landing
  artifacts may only partially conform; this standard governs promoted tables
  intended for analytics and downstream products.

naming:
  standard: "ISO/IEC 11179-aligned; ISO 8601 for dates/weeks"
  case: "snake_case"
  data_elements:
    pattern: "<object_class>_<property>"    # e.g., instrument_symbol, trade_qty
    glossary_authority: "business_glossary" # centralized term approvals
    abbreviations: "discouraged; must exist in glossary if used"
  surrogate_keys:
    pattern: "<entity>_id"                  # 'entity' ≡ 11179 object_class; kept for backward compatibility
    date_key: "date_id"                     # canonical YYYYMMDD integer
  booleans:
    prefix: "is_"
    value_domain: "BOOLEAN"                 # domain-controlled
  dates:
    format: "YYYY-MM-DD"                    # ISO 8601
    week_standard: "ISO-8601"               # ISO week 1–53
  timestamps:
    format: "YYYY-MM-DDTHH:MM:SSZ"          # ISO 8601 UTC 
    timezone: "UTC"                         # all timestamps stored in UTC
    precision: "milliseconds"               # default timestamp precision
    rationale: >
      Consistent naming and formatting reduces cognitive load and parsing errors.
      ISO standards are widely supported and avoid locale ambiguities.

dimensional_modeling:
  philosophy: "Kimball-style conformed dimensions; star schemas preferred."
  dimensions:
    must_have_surrogate_key: true
    must_document_semantics: true
    scd:
      type2_optional: true
      type1_default: true
    naming_conforms_11179: "Dimension attributes follow <object_class>_<property>."
  facts:
    foreign_keys_reference: "conformed dimension surrogate keys"
    grain_must_be_documented: true
    naming_conforms_11179: "Fact attributes follow <object_class>_<property>; measures use clear property names."


columns:
  required_metadata:
    - name
    - dtype
    - semantics
    - object_class      # ISO/IEC 11179 DEC
    - property         # ISO/IEC 11179 DEC
    - value_domain     # required for booleans/enums; document for others
  optional_metadata:
    - rationale
    - tests
  conventions:
    not_null_keys: true
    uniqueness_for_keys: true

governance:
  schema_versioning:
    minors: "Adding nullable columns or metadata is allowed"
    majors: "Removing/renaming columns or changing semantics requires major bump"
  fingerprinting:
    algorithm: "sha256"
    covers: ["columns", "keys", "invariants"]
    enforcement: "advised_for_warehouse"  # not required for raw
    rationale: >
      Fingerprinting is recommended for promoted warehouse tables. Raw landing
      objects may omit fingerprints to maintain Unix-like simplicity.
  metadata_standard:
    name: "ISO/IEC 11179 (scoped)"
    scope: ["naming", "data_element_concepts", "value_domains"]
    glossary_authority: "business_glossary"
    rationale: >
      ISO/IEC 11179 provides a robust framework for metadata management,
      enhancing clarity and consistency across datasets.

tests:
  # Scope: executable checks for promoted (warehouse) tables only.
  agency:
    worker_bot:
      - "Provide per-table schema spec (name, dtype, semantics, object_class, property, value_domain)."
      - "Author/maintain test files for this table; ensure they pass locally."
      - "Fix failures before requesting promotion."
    manager_bot:
      - "Verify required tests exist for the table and are wired into CI."
      - "Run/inspect CI results; block promotion on any failure."
  warehouse_tables:
    - unique_primary_key                # Table has a single unique PK; duplicates fail.
    - not_null_required_columns         # Columns marked required in spec are non-NULL.
    - accepted_values_for_booleans      # BOOLEAN columns declare a domain; values must be within it; NULLs only if allowed.
    - foreign_keys_match_dimensions     # Fact FKs exist in conformed dimensions; no orphans; required FKs non-NULL.
    - naming_conforms_11179             # All column names follow <object_class>_<property>; keys use <entity>_id; terms from glossary.
    - value_domain_enforced             # ENUM/RANGE/SCALAR follow declared domain: sets respected; ranges within bounds; dtype correct.
    - timestamps_normalized_to_utc      # If timestamp columns exist, values are stored in UTC with declared precision (e.g., milliseconds).
  notes:
    - "Raw-layer checks are governed by landing_to_warehouse_contract (LWPC) and are not enforced here."
    - "Document any deviations from the standard process."

landing_to_warehouse_contract:
  title: "Landing→Warehouse Promotion Contract (LWPC)"
  purpose: >
    Define minimum conventions for artifacts produced by ETL landing steps to
    ease promotion into the warehouse.
  rationale: >
    Preserve speed at ingestion while ensuring promotion-readiness. This layer
    guides worker bots and provides the manager bot a lightweight review surface
    to gate promotion—without imposing warehouse-level tests on raw artifacts.
  agency:
    worker_bot_responsibilities:
      - "Produce raw artifacts that meet the minimums in this section."
      - "Run pre-flight lookup (glossary/registry) and attach output to the PR."
    manager_bot_responsibilities:
      - "Review raw_layer_bridge compliance and the acceptance checklist."
      - "Raise a promotion_blocker flag if minimums are unmet or pre-flight is missing."
  flags:
    pre_flight_required: true
    promotion_review_required: true
  minimums:
    - "snake_case identifiers"
    - "date_id (YYYYMMDD int) when a date column exists"
    - "primary uniqueness documented (e.g., obs_date unique for a single-series table)"
    - "NULLs instead of sentinels for missing values"
    - "optional key→value meta table for provenance (e.g., series_meta)"
    - "PRAGMA user_version recommended for SQLite artifacts"


acceptance:
  # Scope: policy gate that ties LWPC compliance + tests + governance into a promotion decision.
  agency:
    worker_bot:
      - "Attach LWPC pre-flight output (registry/glossary lookup) to the PR."
      - "Include per-table schema spec and test artifacts in the same PR."
      - "State SCD type (1/2) and rationale for any dimension changes."
    manager_bot:
      - "Review LWPC compliance and pre-flight evidence; request fixes or alias/view reuse."
      - "Confirm tests.warehouse_tables suite passed in CI; verify SCD-specific checks when applicable."
      - "Check governance items (version bump, fingerprint if used, steward approval, changelog)."
  pre_promotion_review:
    requires:
      - "LWPC minimums satisfied for source artifacts."
      - "Pre-flight registry/glossary check attached (suggest_dimension output)."
  promotion_gates:
    requires:
      - "All tests in tests.warehouse_tables pass for the table(s) in this PR."
      - "SCD validity checks pass when SCD2 is declared (no overlap; single current)."
  governance_checks:
    requires:
      - "Schema_version bump appropriate (minor/major per change)."
      - "Fingerprint updated if enabled."
      - "Steward approval recorded in PR review."
      - "Changelog entry added."
  decision:
    outcomes: ["approve", "block"]
    rule: "Block if any requirement above is unmet; otherwise approve."
  notes:
    - "Acceptance is ingestion-agnostic and references LWPC for raw and tests for warehouse—no duplication."
  rationale: >
    This acceptance policy ensures that only well-defined, tested, and
    governance-compliant artifacts are promoted to the warehouse, maintaining
    data quality and consistency.
